<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="description" content="Trials in Tainted Space Save Editor. View and edit save files." />

    <title>Trials in Tainted Space Save Editor</title>
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico?">

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://kit.fontawesome.com/f5341e91eb.js"></script>

    <script type="text/javascript" src="data/classes.js"></script>
    <script type="text/javascript" src="data/codex.js"></script>
    <script type="text/javascript" src="data/flags.js"></script>
    <script type="text/javascript" src="data/global.js"></script>
    <script type="text/javascript" src="data/perks.js"></script>
    <script type="text/javascript" src="data/status.js"></script>
    <script type="text/javascript" src="data/keyitems.js"></script>
    <script type="text/javascript" src="data/vm.js"></script>

    <script type="text/javascript" src="ui/display.js"></script>
    <script type="text/javascript" src="ui/layout.js"></script>
    <script type="text/javascript" src="ui/container.js"></script>
    <script type="text/javascript" src="ui/input.js"></script>

    <script type="text/javascript" src="scripts/filesaver.js"></script>
    <script type="text/javascript" src="scripts/ko.js"></script>
    <script type="text/javascript" src="scripts/ko-mapping.js"></script>
    <script type="text/javascript" src="scripts/ko-dict.js"></script>
    <script type="text/javascript" src="scripts/util.js"></script>

    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap-mod.css" />
    <link type="text/css" rel="stylesheet" href="styles/main.css" />

    <style>
    </style>

    <script>

        const fileExtension = '.json';


        window.onerror = function (evt, src, ln, col, err) {
            if (err !== null) {

                alert(`An unhandled exception ocurred! If you can, please open a GitHub issue so it can be fixed:\n\n${err}`);

            }
        }


        // #region Load file

        function loadFile(file) {

            if (file.name.endsWith(fileExtension)) {

                var fileReader = new FileReader();
                fileReader.readAsText(file);

                fileReader.addEventListener("loadend", () => {
                    var json;

                    if (typeof fileReader.result !== 'string') {
                        alert('This file has an incorrect format, please check the file and try again.');
                        return;
                    }

                    try {
                        json = JSON.parse(fileReader.result);
                        if (!json['classInstance']) { // this check should be enough for now
                            alert('This file is not a valid TiTS file, please check the file and try again.');
                            return;
                        }
                    }
                    catch (e) {
                        alert("An error ocurred while attempting parse the file\n\n" + e);
                        return;
                    }


                    if (!vm) {
                        vm = new ViewModel(json);
                        koInit();
                    }

                    if (!vm.saveLoaded()) {
                        vm.saveLoaded(true);
                        ko.applyBindings(vm);
                    }
                    else {
                        ko.mapping.fromJS(json, loadMapping, vm.save);
                    }

                    if (!vm.isPC()) {
                        vm.selectedCharacter(vm.characters().find(c => c.name == 'PC'));
                    }

                    const fileName = file.name.replace(fileExtension, '');
                    vm.originalSaveName(fileName);
                    vm.saveName(fileName);

                    alert("Save file loaded!");
                });

            }
            else {
                alert('Selected file is invalid, please select a ' + fileExtension + ' file and try again');
            }

        }

        // #endregion


        // #region GET

        async function getRepoFile(path, func, type = 'text') {
            try {
                await $.get(`https://raw.githubusercontent.com/start-5/TiTS.JS-Save-Editor/main/${path}?killCache=${Date.now()}`, data => func(data), type);
            } catch (e) {
                console.log(e);
            }
        }

        // #endregion


        $(async () => {

            $('#toolbarContainer').collapse();
            $('#toolbarContainer').show();


            $.ajaxSetup({
                cache: false
            });


            // #region Menu content

            await getRepoFile('versions.json', data => {

                const versionData = JSON.parse(data ?? '');

                const gameVersion = versionData.game;
                const gameBreakingVersion = versionData.gameBreaking;

                if (!!gameVersion) {

                    $('#modalInfoBody').append(`<p>Supported game version: <b>${gameVersion}</b></p>`);

                    if (!!gameBreakingVersion) {

                        if (gameVersion.localeCompare(gameBreakingVersion, undefined, { numeric: true, sensitivity: 'base' }) < 0) {

                            const btnMenu = document.getElementById('btnMenu');
                            const iconMenu = document.getElementById('iconMenu');

                            btnMenu.classList.remove('btn-primary')
                            btnMenu.classList.add('btn-danger')

                            iconMenu.classList.remove('fa-bars');
                            iconMenu.classList.add('fa-triangle-exclamation');

                            $('#modalInfoBody').append(`<div class='alert alert-danger'>Version <b>${gameBreakingVersion}</b> of the game introduced breaking changes for the editor. It is very likely that most, if not all, of the editor features won't work for the current version. Please stand by, the issue has been acknowledged and fixes are on the way.</div>`);

                        }

                    }

                }

            });

            await getRepoFile('README_DEPLOY.md', data => {
                $('#modalInfoBody').append(data);
            });


            const showAboutOnPageLoad = localStorage.getItem('showAboutOnPageLoad') === '1';
            const checkShowAboutOnLoad = $('#checkShowAboutOnLoad');

            checkShowAboutOnLoad.prop('checked', showAboutOnPageLoad);
            checkShowAboutOnLoad.on('change', function () {
                localStorage.setItem('showAboutOnPageLoad', this.checked ? '1' : '0');
            })

            if (showAboutOnPageLoad) {
                $('#modalInfo').modal('show');
            }


            // #endregion


            // #region File handling


            $('#inputLoadFile').attr('accept', fileExtension);


            // Drag and Drop listener
            $('body').on('dragenter dragleave dragover', e => {
                e.preventDefault();
                e.stopPropagation();
            });
            $('body').on('drop', e => {
                e.preventDefault();
                e.stopPropagation();

                if (!e.dataTransfer) {
                    e.dataTransfer = e.originalEvent.dataTransfer;
                }

                if (!e.dataTransfer || !e.dataTransfer.files || e.dataTransfer.files.length == 0) {
                    alert('Error loading dropped file, please try again.');
                }
                else {
                    const file = e.dataTransfer.files[0];
                    loadFile(file);
                }
            });


            // Input listener
            $('#inputLoadFile').on('input', function () {

                const file = $(this).prop('files')[0];

                if (!file) {
                    alert('Error loading the file, please try again.');
                }
                else {
                    loadFile(file);
                }

            });


            // Save
            $('#btnSaveFile').on('click', () => {

                var saveObj = ko.mapping.toJS(vm.save);
                if (!saveObj.saveEdited) {
                    saveObj.saveEdited = true;
                }

                const blob = new Blob([JSON.stringify(saveObj)], { type: 'text/json' });

                var fileName = vm.saveName() || vm.originalSaveName();
                if (!fileName) {
                    fileName = "unnamed";
                }

                saveAs(blob, fileName + fileExtension);

            });


            // Prevent saving a file with an empty file name
            $('#inputSaveName').on('change', function () {

                const name = $(this).val();

                if (name.length < 1) {
                    vm.saveName(vm.originalSaveName());
                }

            });


            // #endregion


            // #region Display

            $('#tabGame').append(display.getGame());
            $('#tabStats').append(display.getStats());
            $('#tabHead').append(display.getHead());
            $('#tabBody').append(display.getBody());
            $('#tabCrotch').append(display.getCrotch());
            $('#tabPerks').append(display.getPerks());
            $('#tabStatusEffects').append(display.getStatusEffects());
            $('#tabFlags').append(display.getFlags());
            $('#tabKeyItems').append(display.getKeyItems());

            $('#modalStorageBody').append(display.getStoragePopup());

            $('#tabInventory').append('<p>Low priority, this can be achieved through the game cheat menu.</p>');


            $('#content').show();

            // #endregion

        });


    </script>
</head>


<body class="bg-secondary text-light">


    <div id="content" class="container-fluid hidden">

        <!-- Toolbar -->
        <div class="sticky-top">

            <div id="toolbarContainer">
                <div id="divToolbar" class="bg-info row g-0">

                    <!-- File name -->
                    <div class="col m-2">
                        <div>
                            <label class="visually-hidden" for="inputSaveName">Save File Name</label>
                            <input type="text" class="form-control form-control-sm" id="inputSaveName" disabled data-bind="textInput: saveName, enable: saveLoaded" />
                        </div>
                    </div>

                    <div class="col-sm-auto m-2 ms-0 text-center">

                        <!-- Info -->
                        <button id="btnMenu" type="button" class="btn btn-sm btn-primary mx-2 mx-sm-0" data-bs-toggle="modal" data-bs-target="#modalInfo" title="Menu">
                            <i id="iconMenu" class="fa-solid fa-bars"></i>
                        </button>

                        <!-- Load -->
                        <div class="d-inline-block">
                            <button type="button" class="btn btn-sm btn-primary" onclick="inputLoadFile.click()">
                                <i class="fa-solid fa-upload"></i>  Load file
                            </button>
                            <label class="visually-hidden" for="inputLoadFile">Load File</label>
                            <input class="form-control" type="file" id="inputLoadFile" hidden="hidden">
                        </div>

                        <!-- Save -->
                        <div class="d-inline-block">
                            <button id="btnSaveFile" type="button" class="btn btn-sm btn-primary" disabled data-bind="enable: saveLoaded">
                                <i class="fa-solid fa-floppy-disk"></i>  Save file
                            </button>
                        </div>

                    </div>

                </div>
            </div>

            <!-- Show / Hide -->
            <div class="text-center mx-auto expand-icon rounded-bottom position-relative opacity-50">
                <button data-bs-toggle="collapse" href="#toolbarContainer" type="button" aria-expanded="true" aria-controls="toolbarContainer" class="btn btn-info px-3"
                        title="Collapse/Expand toolbar">
                    <i class="fa-solid fa-arrows-up-down"></i>
                </button>
            </div>

        </div>


        <!-- Selected character -->
        <div class="text-light pb-2 px-3 w-100">
            <label class="label-sm" for="editField-character">Character</label>
            <select id="editField-character" class="form-select form-select-sm" disabled
                    data-bind="options: characters, optionsText: 'name', value: selectedCharacter, enable: saveLoaded"></select>
        </div>


        <!-- Tabs -->
        <div id="editor" class="mt-3">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="navGame" data-bs-toggle="tab" data-bs-target="#tabGame" type="button" role="tab" aria-controls="tabGame" aria-selected="true">Game</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navStats" data-bs-toggle="tab" data-bs-target="#tabStats" type="button" role="tab" aria-controls="tabStats" aria-selected="false">Stats</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navHead" data-bs-toggle="tab" data-bs-target="#tabHead" type="button" role="tab" aria-controls="tabHead" aria-selected="false">Head</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navBody" data-bs-toggle="tab" data-bs-target="#tabBody" type="button" role="tab" aria-controls="tabBody" aria-selected="false">Body</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navCrotch" data-bs-toggle="tab" data-bs-target="#tabCrotch" type="button" role="tab" aria-controls="tabCrotch" aria-selected="false">Crotch</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navPerks" data-bs-toggle="tab" data-bs-target="#tabPerks" type="button" role="tab" aria-controls="tabPerks" aria-selected="false">Perks</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navStatusEffects" data-bs-toggle="tab" data-bs-target="#tabStatusEffects" type="button" role="tab" aria-controls="tabStatusEffects" aria-selected="false">Status Effects</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navFlags" data-bs-toggle="tab" data-bs-target="#tabFlags" type="button" role="tab" aria-controls="tabFlags" aria-selected="false">Flags</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navInventory" data-bs-toggle="tab" data-bs-target="#tabInventory" type="button" role="tab" aria-controls="tabInventory" aria-selected="false">Inventory</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navKeyItems" data-bs-toggle="tab" data-bs-target="#tabKeyItems" type="button" role="tab" aria-controls="tabKeyItems" aria-selected="false">Key Items</button>
                </li>
            </ul>
            <div class="tab-content p-2">
                <div class="tab-pane fade show active" id="tabGame" role="tabpanel" aria-labelledby="navGame"></div>
                <div class="tab-pane fade" id="tabStats" role="tabpanel" aria-labelledby="navStats"></div>
                <div class="tab-pane fade" id="tabHead" role="tabpanel" aria-labelledby="navHead"></div>
                <div class="tab-pane fade" id="tabBody" role="tabpanel" aria-labelledby="navBody"></div>
                <div class="tab-pane fade" id="tabCrotch" role="tabpanel" aria-labelledby="navCrotch"></div>
                <div class="tab-pane fade" id="tabPerks" role="tabpanel" aria-labelledby="navPerks"></div>
                <div class="tab-pane fade" id="tabStatusEffects" role="tabpanel" aria-labelledby="navStatusEffects"></div>
                <div class="tab-pane fade" id="tabFlags" role="tabpanel" aria-labelledby="navFlags"></div>
                <div class="tab-pane fade" id="tabInventory" role="tabpanel" aria-labelledby="navInventory"></div>
                <div class="tab-pane fade" id="tabKeyItems" role="tabpanel" aria-labelledby="navKeyItems"></div>
            </div>
        </div>

    </div>


    <div class="modal fade" id="modalInfo" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-secondary">

                <div class="modal-header">
                    <h5 class="modal-title">About</h5>
                    <button type="button" class="btn-close btn-danger" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div id="modalInfoBody" class="modal-body fs-6">

                </div>

                <div class="modal-footer">

                    <div class="form-check form-switch me-4">
                        <input id="checkShowAboutOnLoad" type="checkbox" role="switch" class="form-check-input storage-switch" />
                        <label class="form-check-label ps-1" for="checkShowAboutOnLoad">Show on page load</label>
                    </div>

                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>


    <div class="modal fade" id="modalStorage" tabindex="-1" aria-hidden="true">
        <div id="modalStorageBody" class="modal-dialog modal-dialog-centered">

        </div>
    </div>


</body>


</html>