<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Trials in Tainted Space Save Editor</title>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/knockout@3.5.1/build/output/knockout-latest.min.js"></script>
    <script type="text/javascript" src="https://kit.fontawesome.com/f5341e91eb.js"></script>
    <script type="text/javascript" src="scripts/filesaver.js"></script>
    <script type="text/javascript" src="scripts/util.js"></script>
    <script type="text/javascript" src="ui/input.js"></script>
    <script type="text/javascript" src="ui/views.js"></script>
    <script type="text/javascript" src="data/global.js"></script>
    <script type="text/javascript" src="data/save.js"></script>

    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap-mod.css" />
    <link type="text/css" rel="stylesheet" href="styles/main.css" />

    <style>
    </style>

    <script>
        //in case they switch to using a custom extension at some point like they do with coc2
        const fileExtension = '.json';

        const save = new Save();

        $(() => {
            $('#divSaveFile').hide();
            $('#inputSaveFileName').hide();
            $('#inputLoadFile').attr('accept', fileExtension);

            $('#toolbarWrapper').collapse();
            $('#toolbarWrapper').show();

            //$('input').blur((e) => {
            //    event.target.checkValidity();
            //}).on('invalid', (e) => {
            //    //setTimeout(function () { $(event.target).focus(); }, 50);
            //    alert('a');
            //});

            //document.getElementById('toolbarWrapper').toggle();

            $('#btnDisclaimer').on('click', () => {
                $('#divDisclaimer').hide();
                doLoad();
            });
        });

        function doLoad() {
            // #region File handling
            $('body').on('dragenter dragleave dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            $('body').on('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (!e.dataTransfer || !e.dataTransfer.files || e.dataTransfer.files.length == 0) {
                    alert('Error loading dropped file, please try again.');
                }
                else {
                    const file = e.dataTransfer.files[0];
                    loadFile(file);
                }
            });

            function loadFile(file) {
                if (file.name.endsWith(fileExtension)) {
                    try {
                        var fileReader = new FileReader();
                        fileReader.readAsText(file);

                        fileReader.addEventListener("loadend", () => {
                            var json;

                            if (typeof fileReader.result !== 'string') {
                                alert('This file has an incorrect format, please check the file and try again.');
                                return;
                            }

                            try {
                                json = JSON.parse(fileReader.result);
                                if (!json['classInstance']) { //this check should be enough for now
                                    alert('This file is in an incorrect format, please check the file and try again.');
                                    return;
                                }
                            }
                            catch (e) {
                                alert("An error ocurred while attempting parse the file\n" + e);
                                return;
                            }

                            save.saveFile = file;
                            save.saveObj = json;
                            

                            const saveContainer = $('#divSaveFile');
                            const inputFileName = $('#inputSaveFileName');
                            if (!saveContainer.is(':visible')) {
                                saveContainer.show();
                            }
                            if (!inputFileName.is(':visible')) {
                                inputFileName.show();
                            }

                            inputFileName.val(save.saveFile.name);


                            const gameInstance = save.saveObj.gameInstanceInfo;
                            const flags = save.saveObj.flags;
                            const pc = save.saveObj.characters.PC;

                            //--placeholder--
                            const tabGeneral = $('#tabGeneral');
                            tabGeneral.append(new Tab([
                                new Row([
                                    new Group('General', [
                                        new TextField2('ballFullness', 'Ball')
                                        //new TextField(gameInstance, 'name', 'Name', null, (newName) => {
                                        //    updateMailState(save.saveObj, 'ToCache', newName + ' Steele');
                                        //}),
                                        //new TextField(flags, 'PC_EMAIL_ADDRESS', 'Email', '@SteeleTech.corp', (newEmail) => {
                                        //    updateMailState(save.saveObj, 'ToAddressCache', newEmail + '@SteeleTech.corp');
                                        //}),
                                        //new IntegerField(pc, 'credits', 'Credits', null, 0),
                                        //new IntegerField(save.saveObj, 'days', 'Days', 'days', 0),
                                        //new IntegerField(save.saveObj, 'hours', 'Hours', 'hours', 0, 23),
                                        //new IntegerField(save.saveObj, 'minutes', 'Minutes', 'minutes', 0, 59)
                                    ]),
                                    new Group('Advancement', [
                                        //new IntegerField(pc, 'level', 'Level', null, 0, 10),
                                        //new SelectField(globalKeys.ValidTypes.Ear, pc, 'earType', 'Ear Type')
                                    ])
                                ]),
                                new Row([
                                    new Group('Stats (only modifiers atm)', [
                                        //new IntegerField(pc, 'physiqueMod', 'Physique Mod', null, 0),
                                        //new IntegerField(pc, 'reflexesMod', 'Reflexes Mod', null, 0),
                                        //new IntegerField(pc, 'aimMod', 'Aim Mod', null, 0),
                                        //new IntegerField(pc, 'intelligenceMod', 'Intelligence Mod', null, 0),
                                        //new IntegerField(pc, 'willpowerMod', 'Willpower Mod', null, 0),
                                        //new IntegerField(pc, 'libidoMod', 'Libido Mod', null, 0, 100)
                                    ])
                                ])
                            ]));

                            save.character = save.saveObj.characters.PC;

                            $('#btnSaveFile').attr('disabled', false);
                            $('#divNoSave').hide();
                            alert("Save file loaded!");
                        });


                    } catch (e) {
                        alert('Error reading file\n' + e)
                    }
                }
                else {
                    alert('Selected file is invalid, please select a ' + fileExtension + ' file and try again');
                }
            }

            $('#inputLoadFile').on('change', () => {
                const input = $('#inputLoadFile');
                var file = input.prop('files')[0];
                if (!file) {
                    alert('Error loading the file, please try again.');
                }
                else {
                    loadFile(file);
                }
            });

            $('#inputSaveFileName').on('focus', () => {
                const input = $('#inputSaveFileName');
                const val = input.val();
                if (val.lastIndexOf(fileExtension) == val.length - 5) {
                    input.val(val.substring(0, val.lastIndexOf(fileExtension)));
                }
            });

            $('#inputSaveFileName').on('blur', () => {
                const input = $('#inputSaveFileName');
                const requiredLength = 1;
                const val = input.val();
                if (val.length >= requiredLength) {
                    input.val(val + fileExtension);
                }
                else {
                    input.val(save.saveFile.name + fileExtension);
                    alert('File name must be ' + requiredLength + ' character' + (requiredLength > 1 ? 's' : '') + ' or longer');
                }
            });

            $('#btnSaveFile').on('click', () => {
                const blob = new Blob([JSON.stringify(save.saveObj)], { type: 'text/json' });
                var fileName = $('#inputSaveFileName').val();
                if (!fileName) {
                    fileName = "unnamed" + fileExtension;
                }
                saveAs(blob, fileName);
            });
            // #endregion

            // #region UI

            // #endregion

            $('#divContent').show();
        }
    </script>
</head>

<body class="bg-secondary text-light needs-validation">
    <div id="divDisclaimer" class="container-fluid text-center p-3">
        <h1 class="display-4">TiTS Save Editor</h1>
        <p>Edit saves at your own risk. If you break or corrupt your savefile don't blame the editor!</p>
        <p>Only JavaScript version save files are supported.</p>

        <br /><br />

        <div>
            <h1 class="display-6">This project is still in development</h1>
            <p>
                Although this page is published, in its current state it is not usable, still, you can track its progress through Github. If you
                have any issue, suggestion, or feature request please post them in the Issues tab on the Github, I'll do my best to look through
                those.
            </p>
        </div>

        <button id="btnDisclaimer" type="button" class="btn btn-info mt-5">Continue</button>
    </div>

    <div id="divContent" class="container-fluid hidden">
        <div id="toolbarWrapper">
            <div id="divToolbar" class="bg-info sticky-top row g-0">
                <div class="col p-2">
                    <div>
                        <input type="text" class="form-control form-control-sm" id="inputSaveFileName" />
                    </div>
                </div>
                <div class="col-sm-auto p-2 text-center">
                    <div id="divLoadFile" class="d-inline-block">
                        <button type="button" class="btn btn-sm btn-primary" onclick="inputLoadFile.click()">Load file</button>
                        <input class="form-control" type="file" id="inputLoadFile" hidden="hidden">
                    </div>
                    <div id="divSaveFile" class="d-inline-block">
                        <button id="btnSaveFile" type="button" class="btn btn-sm btn-primary" disabled>Save file</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-info text-center mx-auto px-3 py-1 expand-icon rounded-bottom position-relative">
            <a data-bs-toggle="collapse" href="#toolbarWrapper" role="button" aria-expanded="true" aria-controls="toolbarWrapper"
               class="link-light underline text-decoration-none stretched-link"><i class="fa-solid fa-arrows-up-down"></i></a>
        </div>

        <div id="divEditor" class="mt-3">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="navGeneral" data-bs-toggle="tab" data-bs-target="#tabGeneral" type="button" role="tab" aria-controls="tabGeneral" aria-selected="true">General</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navHead" data-bs-toggle="tab" data-bs-target="#tabHead" type="button" role="tab" aria-controls="tabHead" aria-selected="false">Head</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navBody" data-bs-toggle="tab" data-bs-target="#tabBody" type="button" role="tab" aria-controls="tabBody" aria-selected="false">Body</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navCrotch" data-bs-toggle="tab" data-bs-target="#tabCrotch" type="button" role="tab" aria-controls="tabCrotch" aria-selected="false">Crotch</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navPerks" data-bs-toggle="tab" data-bs-target="#tabPerks" type="button" role="tab" aria-controls="tabPerks" aria-selected="false">Perks</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navFlags" data-bs-toggle="tab" data-bs-target="#tabFlags" type="button" role="tab" aria-controls="tabFlags" aria-selected="false">Flags</button>
                </li>
            </ul>
            <div class="tab-content p-2">
                <div class="tab-pane fade show active" id="tabGeneral" role="tabpanel" aria-labelledby="navGeneral"></div>
                <div class="tab-pane fade" id="tabHead" role="tabpanel" aria-labelledby="navHead"></div>
                <div class="tab-pane fade" id="tabBody" role="tabpanel" aria-labelledby="navBody"></div>
                <div class="tab-pane fade" id="tabCrotch" role="tabpanel" aria-labelledby="navCrotch"></div>
                <div class="tab-pane fade" id="tabPerks" role="tabpanel" aria-labelledby="navPerks"></div>
                <div class="tab-pane fade" id="tabFlags" role="tabpanel" aria-labelledby="navFlags"></div>
            </div>

            <div id="divNoSave" class="d-flex justify-content-center align-items-center px-2">
                <h4>No save loaded, please click <b>Load file</b> to begin.</h4>
            </div>
        </div>
    </div>
</body>

</html>