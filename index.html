<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Trials in Tainted Space Save Editor</title>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/knockout@3.5.1/build/output/knockout-latest.min.js"></script>
    <script type="text/javascript" src="https://kit.fontawesome.com/f5341e91eb.js"></script>
    <script type="text/javascript" src="scripts/filesaver.js"></script>
    <script type="text/javascript" src="scripts/util.js"></script>
    <script type="text/javascript" src="scripts/internal.js"></script>
    <script type="text/javascript" src="ui/input.js"></script>
    <script type="text/javascript" src="ui/layout.js"></script>
    <script type="text/javascript" src="data/global.js"></script>
    <script type="text/javascript" src="data/save.js"></script>
    <script type="text/javascript" src="data/binding.js"></script>

    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap-mod.css" />
    <link type="text/css" rel="stylesheet" href="styles/main.css" />

    <style>
    </style>

    <script>
        //in case they switch to using a custom extension at some point like they do with coc2
        const fileExtension = '.json';
        const save = new Save();

        $(() => {
            $('#toolbarContainer').collapse();
            $('#toolbarContainer').show();

            $('#btnDisclaimer').on('click', () => {
                $('#disclaimer').hide();
                doLoad();
            });
        });

        function doLoad() {
            $('#loadFile').attr('accept', fileExtension);

            $('#editField-character').on('change', function () {
                const key = $(this).val();
                save.character = {
                    obj: save.saveObj.characters[key],
                    key: key
                };
                //$('.nav-tabs button:first').tab('show'); //this might be annoying
            });

            // #region File handling
            $('body').on('dragenter dragleave dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            $('body').on('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (!e.dataTransfer || !e.dataTransfer.files || e.dataTransfer.files.length == 0) {
                    alert('Error loading dropped file, please try again.');
                }
                else {
                    const file = e.dataTransfer.files[0];
                    loadFile(file);
                }
            });

            function loadFile(file) {
                if (file.name.endsWith(fileExtension)) {
                    try {
                        var fileReader = new FileReader();
                        fileReader.readAsText(file);

                        fileReader.addEventListener("loadend", () => {
                            var json;

                            if (typeof fileReader.result !== 'string') {
                                alert('This file has an incorrect format, please check the file and try again.');
                                return;
                            }

                            try {
                                json = JSON.parse(fileReader.result);
                                if (!json['classInstance']) { //this check should be enough for now
                                    alert('This file is in an incorrect format, please check the file and try again.');
                                    return;
                                }
                            }
                            catch (e) {
                                alert("An error ocurred while attempting parse the file\n" + e);
                                return;
                            }

                            save.saveFile = file;
                            save.saveObj = json;
                            save.oldSaveObj = json;

                            const select = $('#editField-character');
                            select.empty();

                            Object.keys(save.saveObj.characters).forEach(k => {
                                const option = document.createElement('option');
                                option.value = k;
                                option.text = k;
                                option.selected = false;
                                select.append(option);
                            });

                            if (select.attr('disabled')) {
                                select.removeAttr('disabled');
                            }

                            select.val('PC');

                            save.character = {
                                obj: save.saveObj.characters.PC,
                                key: 'PC'
                            }

                            save.SaveLoaded.invoke('saveloaded');

                            $('#saveFile').attr('disabled', false);
                            $('#saveName').attr('disabled', false);
                            $('#saveName').val(save.saveFile.name);
                            alert("Save file loaded!");

                            $('.nav-tabs button:first').tab('show');
                            window.scrollTo({
                                top: 0,
                                left: 0,
                                behavior: 'smooth'
                            })
                        });


                    } catch (e) {
                        alert('Error reading file\n' + e)
                    }
                }
                else {
                    alert('Selected file is invalid, please select a ' + fileExtension + ' file and try again');
                }
            }

            $('#loadFile').on('change', () => {
                const input = $('#loadFile');
                var file = input.prop('files')[0];
                if (!file) {
                    alert('Error loading the file, please try again.');
                }
                else {
                    loadFile(file);
                }
            });

            $('#saveName').on('focus', () => {
                const input = $('#saveName');
                const val = input.val();
                if (val.lastIndexOf(fileExtension) == val.length - 5) {
                    input.val(val.substring(0, val.lastIndexOf(fileExtension)));
                }
            });

            $('#saveName').on('blur', () => {
                const input = $('#saveName');
                const requiredLength = 1;
                const val = input.val();
                if (val.length >= requiredLength) {
                    input.val(val + fileExtension);
                }
                else {
                    input.val(save.saveFile.name + fileExtension);
                    alert('File name must be ' + requiredLength + ' character' + (requiredLength > 1 ? 's' : '') + ' or longer');
                }
            });

            $('#saveFile').on('click', () => {
                const blob = new Blob([JSON.stringify(save.saveObj)], { type: 'text/json' });
                var fileName = $('#saveName').val();
                if (!fileName) {
                    fileName = "unnamed" + fileExtension;
                }
                saveAs(blob, fileName);
            });
            // #endregion

            // #region UI
            // #region Game
            $('#tabGame').append(new Tab([
                new Row([
                    new Group('Internal', [
                        new TextField(new Binding('PC_EMAIL_ADDRESS', 'flags'), 'E-Mail', null, (newEmail) => {
                            updateMailState(save.saveObj, 'ToAddressCache', newEmail + '@SteeleTech.corp');
                        }),
                        new TextField(new Binding('note', 'gameInstanceInfo'), 'Note'),
                        new IntegerField(new Binding('days', '.'), 'Days', 'days', 0),
                        new IntegerField(new Binding('hours', '.'), 'Hours', 'hours', 0, 23),
                        new IntegerField(new Binding('minutes', '.'), 'Minutes', 'minutes', 0, 59)
                    ]),
                    new Group('Game Settings', [
                        new SwitchField(new Binding('easyMode', '.'), 'Easy Mode'),
                        new SwitchField(new Binding('sillyMode', '.'), 'Silly Mode'),
                        new SwitchField(new Binding('miniMapVisible', 'gameInstanceInfo'), 'Minimap visible'),
                        new SwitchField(new Binding('minimapRolledOut', 'gameInstanceInfo'), 'Minimap rolled out'),
                        new SwitchField(new Binding('bustRolledOut', 'gameInstanceInfo'), 'Bust rolled out'),
                        new SwitchField(new Binding('dateTimeVisible', 'gameInstanceInfo'), 'Date and Time visible')
                    ])
                ])
            ]));
            // #endregion

            // #region Stats
            $('#tabStats').append(new Tab([
                new Row([
                    new Group('General', [
                        new TextField(new CharacterBinding('short'), 'Name', null, (newName) => {
                            if (save.character.key == 'PC') {
                                save.saveObj.gameInstanceInfo.name = newName;
                                save.character.obj.uniqueName = newName;
                                updateMailState(save.saveObj, 'ToCache', newName + ' Steele');
                            }
                        }),
                        new IntegerField(new CharacterBinding('credits'), 'Credits', null, 0),
                        new IntegerField(new CharacterBinding('personality'), 'Personality', null, 0, 100),
                        new IntegerField(new CharacterBinding('exhibitionismRaw'), 'Exhibitionism', null, 0, 100)

                    ]),
                    new Group('Advancement', [
                        new IntegerField(new CharacterBinding('level'), 'Level', null, 0, 10),
                        new IntegerField(new CharacterBinding('XPRaw'), 'XP', null, 0),
                        new IntegerField(new CharacterBinding('unspentStatPoints'), 'Stat Points', null, 0)
                    ]),
                    new Group('Shape', [
                        new IntegerField(new CharacterBinding('tallness'), 'Height', 'inches', 0),
                        new IntegerField(new CharacterBinding('thickness'), 'Thickness', null, 0, 100),
                        new IntegerField(new CharacterBinding('tone'), 'Tone', null, 0, 100),
                        new IntegerField(new CharacterBinding('femininity'), 'Femininity', null, 0, 100)
                    ]),
                ]),
                new Row([
                    new Group('Core', [
                        new NestedGroup('', [
                            new IntegerField(new CharacterBinding('Internal_aimRaw'), 'Aim Raw', null, 0),
                            new IntegerField(new CharacterBinding('Internal_intelligenceRaw'), 'Intelligence Raw', null, 0),
                            new IntegerField(new CharacterBinding('Internal_physiqueRaw'), 'Physique Raw', null, 0),
                            new IntegerField(new CharacterBinding('Internal_reflexesRaw'), 'Reflexes Raw', null, 0),
                            new IntegerField(new CharacterBinding('Internal_willpowerRaw'), 'Willpower Raw', null, 0),
                            new IntegerField(new CharacterBinding('Internal_libidoRaw'), 'Libido Raw', null, 0, 100),
                            new IntegerField(new CharacterBinding('Internal_taintRaw'), 'Taint Raw', null, 0, 100)
                        ]),
                        new NestedGroup('', [
                            new IntegerField(new CharacterBinding('aimMod'), 'Aim Mod', null, 0),
                            new IntegerField(new CharacterBinding('intelligenceMod'), 'Intelligence Mod', null, 0),
                            new IntegerField(new CharacterBinding('physiqueMod'), 'Physique Mod', null, 0),
                            new IntegerField(new CharacterBinding('reflexesMod'), 'Reflexes Mod', null, 0),
                            new IntegerField(new CharacterBinding('willpowerMod'), 'Willpower Mod', null, 0),
                            new IntegerField(new CharacterBinding('libidoMod'), 'Libido Mod', null, 0, 100),
                            new IntegerField(new CharacterBinding('taintMod'), 'Taint Mod', null, 0, 100)
                        ])
                    ]),
                    new Group('Combat', [
                        new NestedGroup('', [
                            new IntegerField(new CharacterBinding('HPRaw'), 'HP Raw', null, 0),
                            new IntegerField(new CharacterBinding('energyRaw'), 'Energy Raw', null, 0),
                            new IntegerField(new CharacterBinding('lustRaw'), 'Lust Raw', null, 0),
                            new IntegerField(new CharacterBinding('shieldsRaw'), 'Shields Raw', null, 0)
                        ]),
                        new NestedGroup('', [
                            new IntegerField(new CharacterBinding('HPMod'), 'HP Mod', null, 0),
                            new IntegerField(new CharacterBinding('energyMod'), 'Energy Mod', null, 0),
                            new IntegerField(new CharacterBinding('lustMod'), 'Lust Mod', null, 0)
                        ])
                    ]),
                ])
            ]));
            // #endregion

            // #region Head
            $('#tabHead').append(new Tab([
                new Row([
                    new Group('Head', [
                        new SelectField(globalKeys.HairType, new CharacterBinding('hairType', ValueType.Integer), 'Hair Type'),
                        new FloatField(new CharacterBinding('hairLength'), 'Hair Length', 'inches', 0),
                        new TextField(new CharacterBinding('hairColor'), 'Hair Color'),
                        //hair style todo
                        new SelectField(globalKeys.ValidTypes.Ear, new CharacterBinding('earType', ValueType.Integer), 'Ear Type'),
                        new FloatField(new CharacterBinding('earLength'), 'Ear Length', 'inches', 0),
                        //todo figure out ear flags
                        new SelectField(globalKeys.ValidTypes.Antennae, new CharacterBinding('antennaeType', ValueType.Integer), 'Antennae Type'),
                        new IntegerField(new CharacterBinding('antennae'), 'Antennae Count', 0),
                        new SelectField(globalKeys.ValidTypes.Horn, new CharacterBinding('hornType', ValueType.Integer), 'Horn Type'),
                        new IntegerField(new CharacterBinding('horns'), 'Horn Count', 0),
                        new FloatField(new CharacterBinding('hornLength'), 'Horn Length', 'inches', 0)
                    ]),
                    new Group('Face', [
                        new SelectField(globalKeys.ValidTypes.Face, new CharacterBinding('faceType', ValueType.Integer), 'Face Type'),
                        //todo figure out face flags
                        new SelectField(globalKeys.ValidTypes.Eye, new CharacterBinding('eyeType', ValueType.Integer), 'Eye Type'),
                        new TextField(new CharacterBinding('eyeColor'), 'Hair Color'),
                        new SelectField(globalKeys.ValidTypes.Tongue, new CharacterBinding('tongueType', ValueType.Integer), 'Tongue Type'),
                        //todo figure out tongue flags
                        new TextField(new CharacterBinding('lipColor'), 'Lip Color'),
                        new IntegerField(new CharacterBinding('lipMod'), 'Lip Mod (Size)', 0),
                        new FloatField(new CharacterBinding('beardLength'), 'Beard Length', 'inches', 0),
                        new SelectField(globalKeys.HairType, new CharacterBinding('beardType', ValueType.Integer), 'Beard Type'),
                        // todo beard style
                    ])
                ])
            ]));
            // #endregion

            // #region Body
            $('#tabBody').append(new Tab([
                new Row([
                    new Group('General', [
                        new SwitchField(new CharacterBinding('gills'), 'Has Gills'),
                        new FloatField(new CharacterBinding('elasticity'), 'Elasticity', 0),
                        new SelectField(globalKeys.GenitalSpot, new CharacterBinding('genitalSpot', ValueType.Integer), 'Genital Spot'),
                        new NestedGroup('', [
                            new IntegerField(new CharacterBinding('hipRatingRaw'), 'Hip Rating Raw', 0),
                            new IntegerField(new CharacterBinding('buttRatingRaw'), 'Butt Rating Raw', 0),
                            new IntegerField(new CharacterBinding('bellyRatingRaw'), 'Belly Rating Raw', 0),
                        ]),
                        new NestedGroup('', [
                            new IntegerField(new CharacterBinding('hipRatingMod'), 'Hip Rating Mod', 0),
                            new IntegerField(new CharacterBinding('buttRatingMod'), 'Butt Rating Mod', 0),
                            new IntegerField(new CharacterBinding('bellyRatingMod'), 'Belly Rating Mod', 0),
                        ])
                    ]),
                    new Group('Butt', [
                        //todo virgin
                        new IntegerField(new CharacterBinding('minLooseness', null, 'ass'), 'Min Looseness', 0),
                        new IntegerField(new CharacterBinding('bonusCapacity', null, 'ass'), 'Bonus Capacity', 0),
                        //todo ass flags
                        new NestedGroup('', [
                            new IntegerField(new CharacterBinding('loosenessRaw', null, 'ass'), 'Looseness Raw', 0),
                            new IntegerField(new CharacterBinding('wetnessRaw', null, 'ass'), 'Wetness Raw', 0)
                        ]),
                        new NestedGroup('', [
                            new IntegerField(new CharacterBinding('loosenessMod', null, 'ass'), 'Looseness Mod', 0),
                            new IntegerField(new CharacterBinding('wetnessMod', null, 'ass'), 'Wetness Mod', 0)
                        ])
                    ])
                ]),
                new Row([
                    new Group('Skin', [
                        new SelectField(globalKeys.SkinType, new CharacterBinding('skinType', ValueType.Integer), 'Skin Type'),
                        new TextField(new CharacterBinding('skinTone'), 'Skin Tone'),
                        new TextField(new CharacterBinding('skinAccent'), 'Skin Accent'),
                        new TextField(new CharacterBinding('furColor'), 'Fur Color'),
                        new TextField(new CharacterBinding('scaleColor'), 'Scale Color'),
                        //todo skin flags
                    ]),
                    new Group('Wings', [
                        new SelectField(globalKeys.ValidTypes.Wing, new CharacterBinding('wingType', ValueType.Integer), 'Wing Type'),
                        new IntegerField(new CharacterBinding('wingCount'), 'Wing Count', 0)
                    ])
                ]),
                new Row([
                    new Group('Arms', [
                        new SelectField(globalKeys.ValidTypes.Arm, new CharacterBinding('armType', ValueType.Integer), 'Arm Type'),
                        //todo arm flags
                    ]),
                    new Group('Legs', [
                        new SelectField(globalKeys.ValidTypes.Leg, new CharacterBinding('legType', ValueType.Integer), 'Leg Type'),
                        new IntegerField(new CharacterBinding('legCount'), 'Leg Count', 0),
                        //todo leg flags
                    ])
                ])
            ]));
            // #endregion

            // #endregion

            $('#content').show();
        }
    </script>
</head>

<body class="bg-secondary text-light needs-validation">
    <div id="disclaimer" class="container-fluid text-center p-3">
        <h1 class="display-4">TiTS Save Editor</h1>
        <p>Edit saves at your own risk. If you break or corrupt your savefile don't blame the editor!</p>
        <p>Only JavaScript version save files are supported.</p>

        <br /><br />

        <div>
            <h1 class="display-6">This project is still in development</h1>
            <p>
                Although this page is published, in its current state it is not usable, still, you can track its progress through Github. If you
                have any issue, suggestion, or feature request please post them in the Issues tab on the Github, I'll do my best to look through
                those.
            </p>
        </div>

        <button id="btnDisclaimer" type="button" class="btn btn-info mt-5">Continue</button>
    </div>

    <div id="content" class="container-fluid hidden">
        <div class="sticky-top">
            <div id="toolbarContainer">
                <div id="divToolbar" class="bg-info row g-0">
                    <div class="col p-2">
                        <div>
                            <label class="visually-hidden" for="saveName">Save File Name</label>
                            <input type="text" class="form-control form-control-sm" id="saveName" disabled />
                        </div>
                    </div>
                    <div class="col-sm-auto p-2 text-center">
                        <div id="divLoadFile" class="d-inline-block">
                            <button type="button" class="btn btn-sm btn-primary" onclick="loadFile.click()">Load file</button>
                            <label class="visually-hidden" for="loadFile">Load File</label>
                            <input class="form-control" type="file" id="loadFile" hidden="hidden">
                        </div>
                        <div id="saveFileContainer" class="d-inline-block">
                            <button id="saveFile" type="button" class="btn btn-sm btn-primary" disabled>Save file</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-info text-center mx-auto px-3 py-1 expand-icon rounded-bottom position-relative opacity-50">
                <a data-bs-toggle="collapse" href="#toolbarContainer" role="button" aria-expanded="true" aria-controls="toolbarContainer"
                   class="link-light underline text-decoration-none stretched-link"><i class="fa-solid fa-arrows-up-down"></i></a>
            </div>
        </div>


        <div class="text-light pb-2 px-3 w-100">
            <label class="label-sm" for="editField-character">Character</label>
            <select id="editField-character" class="form-select form-select-sm" disabled></select>
        </div>

        <div id="editor" class="mt-3">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="navGame" data-bs-toggle="tab" data-bs-target="#tabGame" type="button" role="tab" aria-controls="tabGame" aria-selected="true">Game</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navStats" data-bs-toggle="tab" data-bs-target="#tabStats" type="button" role="tab" aria-controls="tabStats" aria-selected="false">Stats</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navHead" data-bs-toggle="tab" data-bs-target="#tabHead" type="button" role="tab" aria-controls="tabHead" aria-selected="false">Head</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navBody" data-bs-toggle="tab" data-bs-target="#tabBody" type="button" role="tab" aria-controls="tabBody" aria-selected="false">Body</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navCrotch" data-bs-toggle="tab" data-bs-target="#tabCrotch" type="button" role="tab" aria-controls="tabCrotch" aria-selected="false">Crotch</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navPerks" data-bs-toggle="tab" data-bs-target="#tabPerks" type="button" role="tab" aria-controls="tabPerks" aria-selected="false">Perks</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="navFlags" data-bs-toggle="tab" data-bs-target="#tabFlags" type="button" role="tab" aria-controls="tabFlags" aria-selected="false">Flags</button>
                </li>
            </ul>
            <div class="tab-content p-2">
                <div class="tab-pane fade show active" id="tabGame" role="tabpanel" aria-labelledby="navGame"></div>
                <div class="tab-pane fade" id="tabStats" role="tabpanel" aria-labelledby="navStats"></div>
                <div class="tab-pane fade" id="tabHead" role="tabpanel" aria-labelledby="navHead"></div>
                <div class="tab-pane fade" id="tabBody" role="tabpanel" aria-labelledby="navBody"></div>
                <div class="tab-pane fade" id="tabCrotch" role="tabpanel" aria-labelledby="navCrotch"></div>
                <div class="tab-pane fade" id="tabPerks" role="tabpanel" aria-labelledby="navPerks"></div>
                <div class="tab-pane fade" id="tabFlags" role="tabpanel" aria-labelledby="navFlags"></div>
            </div>
        </div>
    </div>
</body>

</html>