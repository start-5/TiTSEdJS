<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Trials in Tainted Space Save Editor</title>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/knockout@3.5.1/build/output/knockout-latest.min.js"></script>
    <script type="text/javascript" src="scripts/filesaver.js"></script>
    <script type="text/javascript" src="scripts/util.js"></script>
    <script type="text/javascript" src="ui/input.js"></script>
    <script type="text/javascript" src="scripts/ko-mapping.js"></script>

    <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap-mod.css" />
    <link type="text/css" rel="stylesheet" href="styles/main.css" />

    <style>
    </style>

    <script>
        //in case they switch to using a custom extension at some point like they do with coc2
        const fileExtension = '.json';

        var loaded_save = {};
        var loaded_save_name = '';
        var editFields = [];

        $(() => {
            $('#btnDisclaimer').on('click', () => {
                $('#divDisclaimer').hide();
                doLoad();
            });
        });

        function doLoad() {
            // #region File handling
            $('#divSaveFile').hide();
            $('#inputSaveFileName').hide();
            $('#inputLoadFile').attr('accept', fileExtension);

            $('body').on('dragenter dragleave dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            $('body').on('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();

                if (!e.dataTransfer || !e.dataTransfer.files || e.dataTransfer.files.length == 0) {
                    alert('Error loading file');
                }
                else {
                    const file = e.dataTransfer.files[0];
                    loadFile(file);
                }
            });

            function loadFile(file) {
                if (file.name.endsWith(fileExtension)) {
                    try {
                        var fileReader = new FileReader();
                        fileReader.readAsText(file);

                        fileReader.addEventListener("loadend", () => {
                            var json;

                            if (typeof fileReader.result !== 'string') {
                                alert('This file has an incorrect format, please check the file and try again.');
                                return;
                            }

                            try {
                                json = JSON.parse(fileReader.result);
                                if (!json['classInstance']) { //this check should be enough for now
                                    alert('This file has an incorrect format, please check the file and try again.');
                                    return;
                                }
                            }
                            catch (e) {
                                alert("There was an error when attempting to parse the file\n" + e);
                                return;
                            }

                            loaded_save = json;

                            const saveContainer = $('#divSaveFile');
                            const inputFileName = $('#inputSaveFileName');
                            if (!saveContainer.is(':visible')) {
                                saveContainer.show(400);
                            }
                            if (!inputFileName.is(':visible')) {
                                inputFileName.show(400);
                            }
                            inputFileName.val(file.name);
                            loaded_save_name = file.name;


                            const gameInstance = loaded_save.gameInstanceInfo;
                            const flags = loaded_save.flags;

                            //placeholder
                            document.getElementById('divEditor').appendChild(
                                new TextField(gameInstance, 'name', 'Name', null, (newName) => {
                                    updateMailState(loaded_save, 'ToCache', newName + ' Steele');
                                })
                            );
                            document.getElementById('divEditor').appendChild(
                                new TextField(flags, 'PC_EMAIL_ADDRESS', 'Email', null, (newEmail) => {
                                    updateMailState(loaded_save, 'ToAddressCache', newEmail + '@SteeleTech.corp');
                                })
                            );
                            document.getElementById('divEditor').appendChild(
                                new IntegerField(loaded_save, 'days', 'Days', 'days', 0)
                            );
                            document.getElementById('divEditor').appendChild(
                                new IntegerField(loaded_save, 'hours', 'Hours', 'hours', 0, 23)
                            );

                            $('#divNoSave').hide();
                            alert("Save file loaded!");
                        });


                    } catch (e) {
                        alert('Error reading file\n' + e)
                    }
                }
                else {
                    alert('Selected file is invalid, please select a ' + fileExtension + ' file and try again');
                }
            }

            $('#inputLoadFile').on('change', () => {
                const input = $('#inputLoadFile');
                var file = input.prop('files')[0];
                if (!file) {
                    alert('Error loading the file, please try again.');
                }
                else {
                    loadFile(file);
                }
            });

            $('#inputSaveFileName').on('focus', () => {
                const input = $('#inputSaveFileName');
                const val = input.val();
                if (val.lastIndexOf(fileExtension) == val.length - 5) {
                    input.val(val.substring(0, val.lastIndexOf(fileExtension)));
                }
            });

            $('#inputSaveFileName').on('blur', () => {
                const input = $('#inputSaveFileName');
                const requiredLength = 1;
                const val = input.val();
                if (val.length >= requiredLength) {
                    input.val(val + fileExtension);
                }
                else {
                    input.val(loaded_save_name + fileExtension);
                    alert('File name must be ' + requiredLength + ' character' + (requiredLength > 1 ? 's' : '') + ' or longer');
                }
            });

            $('#btnSaveFile').on('click', () => {
                const blob = new Blob([JSON.stringify(loaded_save)], { type: 'text/json' });
                var fileName = $('#inputSaveFileName').val();
                if (!fileName) {
                    fileName = "unnamed" + fileExtension;
                }
                saveAs(blob, fileName);
            });
            // #endregion

            $('#divContent').show();
        }
    </script>
</head>

<body class="bg-secondary text-light">
    <div id="divDisclaimer" class="container-fluid text-center p-3">
        <h1 class="display-4">TiTS Save Editor</h1>
        <p>Edit saves at your own risk. If you break or corrupt your savefile don't blame the editor!</p>
        <p>Only JavaScript version save files are supported.</p>

        <br /><br />

        <div>
            <h1 class="display-6">This project is still in development</h1>
            <p>
                Although this page is published, in its current state it is not usable, still, you can track its progress through Github. If you
                have any issue, suggestion, or feature request please post them in the Issues tab on the Github, I'll do my best to look through
                those.
            </p>
        </div>

        <button id="btnDisclaimer" type="button" class="btn btn-info mt-5">Continue</button>
    </div>

    <div id="divContent" class="container-fluid hidden">
        <div id="divToolbar" class="bg-info fixed-top">
            <div class="row m-2 justify-content-between">
                <div class="col-6 justify-content-start">
                    <div>
                        <input type="text" class="form-control form-control-sm" id="inputSaveFileName" />
                    </div>
                </div>
                <div class="row col-6 justify-content-end">
                    <div id="divLoadFile" class="col-auto">
                        <button type="button" class="btn btn-sm btn-primary" onclick="inputLoadFile.click()">Load file</button>
                        <input class="form-control" type="file" id="inputLoadFile" hidden="hidden">
                    </div>
                    <div id="divSaveFile" class="col-auto">
                        <button id="btnSaveFile" type="button" class="btn btn-sm btn-primary">Save file</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="divEditor" class="mt-5">
            <div id="divNoSave" class="centered">
                <h3>No save loaded, please click <span class="font-weight-bold">Load file</span> to begin.</h3>
            </div>
        </div>
    </div>
</body>

</html>